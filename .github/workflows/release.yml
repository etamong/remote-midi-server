name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # macOS builds (with MIDI support via CGO)
          - os: macos-latest
            goos: darwin
            goarch: amd64
            artifact_name: remote-midi-server-darwin-amd64
            cgo_enabled: 1
          - os: macos-latest
            goos: darwin
            goarch: arm64
            artifact_name: remote-midi-server-darwin-arm64
            cgo_enabled: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install pkg-config

      - name: Download dependencies
        run: |
          go mod download
          go mod tidy

      - name: Build binary
        env:
          CGO_ENABLED: ${{ matrix.cgo_enabled }}
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -o ${{ matrix.artifact_name }} -ldflags="-s -w" cmd/server/main.go

      - name: Create archive (Unix)
        if: matrix.goos != 'windows'
        run: |
          tar czf ${{ matrix.artifact_name }}.tar.gz \
            ${{ matrix.artifact_name }} \
            web/ \
            config.yaml \
            README.md

      - name: Create archive (Windows)
        if: matrix.goos == 'windows'
        run: |
          zip -r ${{ matrix.artifact_name }}.zip \
            ${{ matrix.artifact_name }} \
            web/ \
            config.yaml \
            README.md

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.tar.gz
            ${{ matrix.artifact_name }}.zip

  create-release:
    name: Create Release
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        id: notes
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create release notes
          cat << EOF > release_notes.md
          ## ðŸŽ‰ Remote MIDI Server ${GITHUB_REF_NAME}

          ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ MIDI ì‹ í˜¸ë¥¼ ì œì–´í•  ìˆ˜ ìžˆëŠ” ì›ê²© MIDI ì»¨íŠ¸ë¡¤ëŸ¬ìž…ë‹ˆë‹¤.

          ### ðŸ“¦ ì„¤ì¹˜ ë°©ë²•

          #### Docker (ê¶Œìž¥):
          \`\`\`bash
          docker pull ghcr.io/etamong/remote-midi-server:${GITHUB_REF_NAME}
          docker run -d -p 8080:8080 -v \$(pwd)/config.yaml:/app/config.yaml:ro ghcr.io/etamong/remote-midi-server:${GITHUB_REF_NAME}
          \`\`\`

          #### ë°”ì´ë„ˆë¦¬:
          1. ì•„ëž˜ì—ì„œ OSì— ë§žëŠ” íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          2. ì••ì¶• í•´ì œ
          3. \`./remote-midi-server\` ì‹¤í–‰
          4. ë¸Œë¼ìš°ì €ì—ì„œ \`http://localhost:8080\` ì ‘ì†

          ### ðŸ“ ë³€ê²½ì‚¬í•­

          ${CHANGELOG}

          ### ðŸ³ Docker ì´ë¯¸ì§€

          - \`ghcr.io/etamong/remote-midi-server:${GITHUB_REF_NAME}\`
          - \`ghcr.io/etamong/remote-midi-server:latest\`

          ### ðŸ’¾ ì²´í¬ì„¬

          ë¦´ë¦¬ìŠ¤ íŒŒì¼ì˜ SHA256 ì²´í¬ì„¬ì€ ì•„ëž˜ ì°¸ì¡°í•˜ì„¸ìš”.
          EOF

          cat release_notes.md

      - name: Generate checksums
        run: |
          cd artifacts
          find . -name "*.tar.gz" -o -name "*.zip" | while read file; do
            sha256sum "$file" >> ../checksums.txt
          done
          cd ..
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            checksums.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
